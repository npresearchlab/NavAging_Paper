---
title: "Figure 9 Code - Optimized"
output: html_document
date: "2024"
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r loading-libraries, include=FALSE}
# Load required libraries for data analysis and visualization
library(tidyverse)    # Data manipulation and ggplot2
library(plotrix)      # For std.error function
library(gridExtra)    # Arranging multiple plots
library(scales)       # Scale formatting
```

```{r setup-paths, include=FALSE}
# Define file paths - MODIFY THESE FOR YOUR SYSTEM
data_path <- "/Volumes/YB_Drive/NavAging_Paper/data"
output_path <- "/Volumes/YB_Drive/NavAging_Paper/figure_creation/plots"
```

```{r load-and-process-data, include=FALSE}
# Function to load and standardize navigation data (no column renaming needed)
load_nav_data <- function(file_path, age_group) {
  # Read CSV file
  data <- read.csv(file_path)
  
  # Add age group column and remove index
  data <- data %>%
    select(-1) %>%  # Remove first column (index)
    mutate(
      Age = age_group,
      Block_Num = as.factor(Block_Num)
    )
  
  return(data)
}

# Load navigation datasets (using merged data for change score calculation)
ya_nav_data <- load_nav_data(file.path(data_path, "ya_merged_results.csv"), "YA")
oa_nav_data <- load_nav_data(file.path(data_path, "oa_merged_results.csv"), "OA")

# Load non-navigation data (NARA scores, etc.)
non_nav_data <- read.csv(file.path(data_path, "non_nav_data.csv")) %>%
  select(-age)  # Remove Age column to avoid conflicts

# Combine navigation datasets
all_nav_data <- bind_rows(ya_nav_data, oa_nav_data) %>%
  mutate(Age = factor(Age, levels = c("YA", "OA")))

print(paste("Loaded navigation data for", nrow(all_nav_data), "trials"))
print(paste("Loaded non-navigation data for", nrow(non_nav_data), "participants"))
```

```{r calculate-change-scores, include=FALSE}
# Calculate change scores (Block 3 - Block 1) efficiently
# This replaces the inefficient for loops with vectorized operations

# Calculate overall means across all targets for each participant-block combination
block_means <- all_nav_data %>%
  group_by(Participant, Block_Num, Age) %>%
  summarise(
    Total_Time = mean(Total_Time, na.rm = TRUE),
    Orientation_Time = mean(Orientation_Time, na.rm = TRUE),
    Navigation_Time = mean(Navigation_Time, na.rm = TRUE),
    Distance = mean(Distance, na.rm = TRUE),
    Speed = mean(Speed, na.rm = TRUE),
    Mean_Dwell = mean(Mean_Dwell, na.rm = TRUE),
    Teleportations = mean(Teleportations, na.rm = TRUE),
    .groups = 'drop'
  )

# Calculate change scores (Block 3 - Block 1)
change_scores <- block_means %>%
  filter(Block_Num %in% c("1", "3")) %>%
  pivot_wider(
    names_from = Block_Num,
    values_from = c(Total_Time, Orientation_Time, Navigation_Time, 
                   Distance, Speed, Mean_Dwell, Teleportations),
    names_sep = "_Block_"
  ) %>%
  mutate(
    Total_Time = Total_Time_Block_3 - Total_Time_Block_1,
    Orientation_Time = Orientation_Time_Block_3 - Orientation_Time_Block_1,
    Navigation_Time = Navigation_Time_Block_3 - Navigation_Time_Block_1,
    Distance = Distance_Block_3 - Distance_Block_1,
    Speed = Speed_Block_3 - Speed_Block_1,
    Mean_Dwell = Mean_Dwell_Block_3 - Mean_Dwell_Block_1,
    Teleportations = Teleportations_Block_3 - Teleportations_Block_1
  ) %>%
  select(Participant, Age, Total_Time, Orientation_Time, Navigation_Time, 
         Distance, Speed, Mean_Dwell, Teleportations)

# Merge with NARA scores
df_merge <- change_scores %>%
  left_join(non_nav_data, by = "Participant") %>%
  filter(!is.na(NARA))  # Remove participants without NARA scores

# Create separate datasets for age group analyses
ya_data <- filter(df_merge, Age == "YA")
oa_data <- filter(df_merge, Age == "OA")

print(paste("Calculated change scores and merged with NARA for", nrow(df_merge), "participants"))
print(paste("YA participants:", nrow(ya_data)))
print(paste("OA participants:", nrow(oa_data)))
```

```{r plotting-functions, include=FALSE}
# Function to save plots with consistent settings
save_plot <- function(plot, filename, width = 5, height = 5) {
  ggsave(
    filename = file.path(output_path, paste0(filename, ".svg")),
    plot = plot,
    width = width,
    height = height
  )
  cat("Saved:", filename, "\n")
}

# Function to create standardized correlation scatter plots
create_correlation_plot <- function(data, x_var, x_label, colors = c('#FF9FAF', '#5E7AFA')) {
  
  ggplot(data, aes(x = .data[[x_var]], y = NARA, color = Age, fill = Age)) +
    geom_point(size = 2, position = position_jitter(h = 0, w = 0.15)) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    stat_smooth(method = 'lm', formula = y ~ x) +
    labs(
      x = x_label,
      y = "NARA Score",
      color = "Age Group"
    ) +
    ylim(0, 100) +
    theme_classic() +
    theme(
      panel.background = element_rect(fill = "white", linewidth = 0.5, colour = "#242526"),
      axis.line = element_line(linewidth = 0.5, colour = "#242526"),
      axis.ticks = element_line(linewidth = 0.2, colour = "#242526"),
      plot.title = element_text(hjust = 0.5),
      axis.text.x = element_text(size = 20),
      axis.text.y = element_text(size = 20),
      axis.title.y = element_text(size = 20),
      axis.title.x = element_text(size = 20),
      legend.position = 'none'
    )
}
```

```{r correlation-analysis-function, include=FALSE}
# Function to perform correlation analysis for a given variable
analyze_correlations <- function(data_all, data_ya, data_oa, var_name) {
  # Helper function to safely perform correlation test
  safe_cor_test <- function(x, y, group_name) {
    if (length(x) < 3 || length(y) < 3 || all(is.na(x)) || all(is.na(y))) {
      return(tibble(
        group = group_name,
        variable = var_name,
        n = length(x),
        r = NA,
        p_value = NA,
        significant = FALSE
      ))
    }
    
    cor_result <- cor.test(x, y, method = "pearson")
    tibble(
      group = group_name,
      variable = var_name,
      n = length(x),
      r = round(cor_result$estimate, 3),
      p_value = round(cor_result$p.value, 4),
      significant = cor_result$p.value < 0.05
    )
  }
  
  # Perform correlations for all groups
  bind_rows(
    safe_cor_test(data_all[[var_name]], data_all$NARA, "All"),
    safe_cor_test(data_ya[[var_name]], data_ya$NARA, "YA"),
    safe_cor_test(data_oa[[var_name]], data_oa$NARA, "OA")
  )
}
```

```{r create-all-plots, include=FALSE}
# Define plot specifications for easy management
plot_specs <- tribble(
  ~var_name,           ~label,                              ~plot_name,
  "Distance",          "Δ Distance Traveled (VR Units)",   "dt",
  "Total_Time",        "Δ Total Time",                     "ct",
  "Orientation_Time",  "Δ Orientation Time",               "orict",
  "Navigation_Time",   "Δ Navigation Time",                "navct",
  "Speed",             "Δ Speed",                          "speed",
  "Teleportations",    "Δ Teleportations",                 "teleport",
  "Mean_Dwell",        "Δ Mean Dwell Time (s)",            "dwell"
)

# Create all plots using functional programming
plots <- map2(plot_specs$var_name, plot_specs$label, function(var, label) {
  create_correlation_plot(df_merge, var, label)
})

# Name the plots for easy reference
names(plots) <- paste0("p_", plot_specs$plot_name)

# Extract individual plots for backward compatibility
p_dt <- plots$p_dt
p_ct <- plots$p_ct
p_orict <- plots$p_orict
p_navct <- plots$p_navct
p_speed <- plots$p_speed
p_teleport <- plots$p_teleport
p_dwell <- plots$p_dwell

print("Created all correlation plots")
```

```{r perform-correlations, include=FALSE}
# Perform correlation analyses for all variables
all_correlations <- map_dfr(plot_specs$var_name, function(var) {
  analyze_correlations(df_merge, ya_data, oa_data, var)
})

print("Correlation analysis results:")
print(all_correlations)

# Create a summary table of significant correlations
significant_correlations <- all_correlations %>%
  filter(significant == TRUE) %>%
  arrange(desc(abs(r)))

if (nrow(significant_correlations) > 0) {
  print("Significant correlations (p < 0.05):")
  print(significant_correlations)
} else {
  print("No significant correlations found (p < 0.05)")
}
```

```{r save-individual-plots, include=FALSE}
# Save all individual plots
plot_names <- paste0("fig9_", plot_specs$plot_name)
walk2(plots, plot_names, ~ save_plot(.x, .y))
```

```{r create-composite-figure, fig.height=16, fig.width=20, fig.align="center"}
# Create composite figure with all plots arranged in a grid
composite_plot <- grid.arrange(
  p_speed, p_ct, p_orict, p_navct,     # Row 1
  p_dt, p_dwell, p_teleport,           # Row 2 (3 plots)
  ncol = 4, 
  nrow = 2
)

# Save composite figure
save_plot(composite_plot, "fig9_composite", width = 20, height = 16)
```

```{r summary-statistics, include=FALSE}
# Generate descriptive statistics
descriptive_stats <- df_merge %>%
  group_by(Age) %>%
  summarise(
    n = n(),
    across(c(NARA, Total_Time, Orientation_Time, Navigation_Time, Distance, 
             Speed, Mean_Dwell, Teleportations), 
           list(mean = ~ round(mean(.x, na.rm = TRUE), 2),
                sd = ~ round(sd(.x, na.rm = TRUE), 2)),
           .names = "{.col}_{.fn}"),
    .groups = 'drop'
  )

print("Descriptive statistics by age group:")
print(descriptive_stats)

# Range information for change scores
change_ranges <- df_merge %>%
  summarise(
    across(c(Total_Time, Orientation_Time, Navigation_Time, Distance, 
             Speed, Mean_Dwell, Teleportations),
           list(min = ~ round(min(.x, na.rm = TRUE), 2),
                max = ~ round(max(.x, na.rm = TRUE), 2)),
           .names = "{.col}_{.fn}")
  )

print("Change score ranges (Block 3 - Block 1):")
print(change_ranges)
```