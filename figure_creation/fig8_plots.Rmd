---
title: "Figure 8 Code - Optimized"
output: html_document
date: "2024"
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r loading-libraries, include=FALSE}
# Load required libraries for data analysis and visualization
library(tidyverse)    # Data manipulation and ggplot2
library(plotrix)      # For std.error function
library(ggdist)       # Statistical distributions for ggplot2
library(gghalves)     # Half-violin plots
library(scales)       # Scale formatting
```

```{r setup-paths, include=FALSE}
# Define file paths - MODIFY THESE FOR YOUR SYSTEM
data_path <- "/Volumes/YB_Drive/NavAging_Paper/data"
output_path <- "/Volumes/YB_Drive/NavAging_Paper/figure_creation/plots"
```

```{r load-and-process-data, include=FALSE}
# Function to load and standardize navigation data (no column renaming needed)
load_nav_data <- function(file_path, age_group, has_target = FALSE) {
  # Read CSV file
  data <- read.csv(file_path)
  
  # Add age group column and remove index
  data <- data %>%
    select(-1) %>%  # Remove first column (index)
    mutate(
      Age = age_group,
      Block_Num = as.factor(Block_Num)
    )
  
  # Set target ordering only if this dataset has Target_Name column
  if (has_target) {
    desired_order <- c("Automobile shop", "Police station ", "Fire Station", 
                      "Bank", "Pawn Shop", "Pizzeria", "Quattroki Restaurant", 
                      "High School")
    data$Target_Name <- factor(data$Target_Name, levels = desired_order)
  }
  
  return(data)
}

# Load navigation datasets
ya_data <- load_nav_data(file.path(data_path, "ya_averaged_results.csv"), "YA")
oa_data <- load_nav_data(file.path(data_path, "oa_averaged_results.csv"), "OA")
ya_nav_data <- load_nav_data(file.path(data_path, "ya_merged_results.csv"), "YA", has_target = TRUE)
oa_nav_data <- load_nav_data(file.path(data_path, "oa_merged_results.csv"), "OA", has_target = TRUE)

# Load non-navigation data (NARA scores, etc.)
non_nav_data <- read.csv(file.path(data_path, "non_nav_data.csv"))

# Combine datasets
all_avg_data <- bind_rows(ya_data, oa_data) %>%
  mutate(Age = factor(Age, levels = c("YA", "OA")))

all_nav_data <- bind_rows(ya_nav_data, oa_nav_data) %>%
  mutate(Age = factor(Age, levels = c("YA", "OA")))

print(paste("Loaded averaged data for", nrow(all_avg_data), "participant-blocks"))
print(paste("Loaded navigation data for", nrow(all_nav_data), "trials"))
print(paste("Loaded non-navigation data for", nrow(non_nav_data), "participants"))
```

```{r calculate-overall-means, include=FALSE}
# Calculate overall means across all blocks and targets for each participant
# This replaces the inefficient for loop with vectorized operations

mean_data <- all_nav_data %>%
  # Group by participant and age to average across all blocks and targets
  group_by(Participant, Age) %>%
  summarise(
    Total_Time = mean(Total_Time, na.rm = TRUE),
    Orientation_Time = mean(Orientation_Time, na.rm = TRUE),
    Navigation_Time = mean(Navigation_Time, na.rm = TRUE),
    Distance = mean(Distance, na.rm = TRUE),
    Speed = mean(Speed, na.rm = TRUE),
    Mean_Dwell = mean(Mean_Dwell, na.rm = TRUE),
    Teleportations = mean(Teleportations, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(Age = factor(Age, levels = c("YA", "OA")))

print(paste("Calculated overall means for", nrow(mean_data), "participants"))
```

```{r prepare-nara-data, include=FALSE}
# Prepare NARA data with proper grouping and labeling
nara_data <- non_nav_data %>%
  # Create NARA performance labels
  mutate(
    # Standardize group names to match other datasets
    Group = factor(Group, levels = c("YA", "OA")),
    
    # Create three-group classification based on NARA performance
    nara_labels = case_when(
      Group == "YA" ~ "YA",
      Group == "OA" & NARA > 50 ~ "OA High", 
      Group == "OA" & NARA <= 50 ~ "OA Low",
      TRUE ~ NA_character_
    ),
    nara_labels = factor(nara_labels, levels = c("YA", "OA High", "OA Low"))
  )

print("NARA data summary:")
print(table(nara_data$nara_labels, useNA = "ifany"))
```

```{r plotting-functions, include=FALSE}
# Function to save plots with consistent settings
save_plot <- function(plot, filename, width = 5, height = 5) {
  ggsave(
    filename = file.path(output_path, paste0(filename, ".svg")),
    plot = plot,
    width = width,
    height = height
  )
  cat("Saved:", filename, "\n")
}

# Function to create NARA raincloud plot
create_nara_raincloud <- function(data, colors = c('#FF9FAF', '#5E7AFA')) {
  ggplot(data, aes(x = Group, y = NARA, fill = Group, color = Group)) +
    scale_fill_manual(values = colors) +
    scale_color_manual(values = colors) +
    scale_y_continuous(breaks = pretty_breaks(n = 4)) +
    labs(y = "NARA Score (%)", x = "") +
    scale_x_discrete(limits = c("YA", "OA")) +
    theme_classic() +
    theme(
      axis.line = element_line(linewidth = 0.5, colour = "#242526"),
      axis.ticks = element_line(linewidth = 0.2, colour = "#242526"),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none",
      axis.text.x = element_text(size = 20),
      axis.text.y = element_text(size = 20),
      axis.title.y = element_text(size = 20)
    ) +
    stat_halfeye(
      adjust = 0.5,
      justification = -0.2,
      .width = 0,
      point_colour = NA,
      scale = 0.5
    ) +
    geom_boxplot(
      width = 0.12,
      outlier.color = NA,
      alpha = 0.5
    ) +
    geom_half_point(
      side = 'l',
      range_scale = 0.4,
      alpha = 0.3,
      position = position_jitter(seed = 1, width = 0.12, height = 0)
    )
}

# Function to create scatter plots with correlation lines
create_correlation_plot <- function(data, color_var = "Group", colors = c('#FF9FAF', '#5E7AFA')) {
  ggplot(data, aes(x = Age, y = NARA, color = .data[[color_var]])) +
    geom_point(size = 2) +
    scale_color_manual(values = colors) +
    labs(y = "NARA Score (%)", x = "Age") +
    theme_classic() +
    theme(
      axis.line = element_line(linewidth = 0.5, colour = "#242526"),
      axis.ticks = element_line(linewidth = 0.2, colour = "#242526"),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none",
      axis.text.x = element_text(size = 20),
      axis.text.y = element_text(size = 20),
      axis.title.y = element_text(size = 20),
      axis.title.x = element_text(size = 20)
    ) +
    geom_smooth(
      aes(group = .data[[color_var]]), 
      method = "lm", 
      se = TRUE, 
      color = "#242526", 
      fill = 'lightgray'
    )
}
```

```{r create-nara-plots, include=FALSE}
# Create NARA visualization plots

# 1. Raincloud plot comparing YA vs OA
plot_nara_rain <- create_nara_raincloud(nara_data)

# 2. Age-NARA correlation plot (two groups)
plot_nara_corr <- create_correlation_plot(nara_data)

# 3. Age-NARA correlation plot (three groups: YA, OA-high, OA-low)
plot_nara_three <- create_correlation_plot(
  nara_data, 
  color_var = "nara_labels",
  colors = c('#FF9FAF', '#7f00fe', '#c5b3de')  # YA, oa_high, oa_low
)

print("Created all NARA plots")
```

```{r save-plots, include=FALSE}
# Save all plots
save_plot(plot_nara_rain, "fig8_nara_rain")
save_plot(plot_nara_corr, "fig8_nara_corr")
save_plot(plot_nara_three, "fig8_nara_three")
```

```{r summary-statistics, include=FALSE}
# Generate summary statistics for NARA data

nara_summary <- nara_data %>%
  group_by(Group) %>%
  summarise(
    n = n(),
    mean_nara = round(mean(NARA, na.rm = TRUE), 2),
    sd_nara = round(sd(NARA, na.rm = TRUE), 2),
    median_nara = round(median(NARA, na.rm = TRUE), 2),
    min_nara = round(min(NARA, na.rm = TRUE), 2),
    max_nara = round(max(NARA, na.rm = TRUE), 2),
    mean_age = round(mean(Age, na.rm = TRUE), 1),
    .groups = 'drop'
  )

print("NARA summary statistics by group:")
print(nara_summary)

# Three-group summary
nara_three_summary <- nara_data %>%
  group_by(nara_labels) %>%
  summarise(
    n = n(),
    mean_nara = round(mean(NARA, na.rm = TRUE), 2),
    sd_nara = round(sd(NARA, na.rm = TRUE), 2),
    mean_age = round(mean(Age, na.rm = TRUE), 1),
    .groups = 'drop'
  )

print("NARA summary statistics by three-group classification:")
print(nara_three_summary)
```
