---
title: "2-Group Correlations for NARA and NavCity Outcome Measures (Spearman)"
author: "Yasmine Bassil"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

## Setup and Data Loading

```{r loading-libraries, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(corrr)
library(knitr)
library(ggplot2)
library(reshape2)
library(tidyr)
library(kableExtra)
```

```{r loading-data, message=FALSE, warning=FALSE}

# Load the datasets
oa_data <- read_csv("/Volumes/YB_Drive/NavAging_Paper/data/oa_averaged_results.csv")
ya_data <- read_csv("/Volumes/YB_Drive/NavAging_Paper/data/ya_averaged_results.csv")
non_nav_data <- read_csv("/Volumes/YB_Drive/NavAging_Paper/data/non_nav_data.csv")

# Display basic information about the datasets
cat("OA data dimensions:", dim(oa_data), "\n")
cat("YA data dimensions:", dim(ya_data), "\n")
cat("Non-navigation data dimensions:", dim(non_nav_data), "\n")
```

## Data Preparation

```{r data_prep}
# Combine OA and YA navigation data
# First, ensure consistent column names
ya_data <- ya_data %>% select(-1)  # Remove the unnamed first column
oa_data <- oa_data %>% select(-1)  # Remove the unnamed first column

# Combine the datasets
nav_combined <- bind_rows(
  oa_data %>% mutate(Group = "OA"),
  ya_data %>% mutate(Group = "YA")
)

# Define outcome measures
outcome_measures <- c("Total_Time", "Orientation_Time", "Navigation_Time", 
                     "Speed", "Distance", "Mean_Dwell", "Teleportations", 
                     "Mean_Teleport_Distance")

# Merge navigation data with NARA scores
# First, get NARA scores for each participant
nara_scores <- non_nav_data %>% 
  select(Participant, NARA, Group)

# Merge with navigation data
nav_with_nara <- nav_combined %>%
  left_join(nara_scores, by = "Participant")

# Check for missing NARA scores
missing_nara <- nav_with_nara %>% 
  filter(is.na(NARA)) %>%
  select(Participant) %>%
  distinct()

if(nrow(missing_nara) > 0) {
  cat("Participants without NARA scores:\n")
  print(missing_nara)
} else {
  cat("All participants have NARA scores.\n")
}

# Display merged data summary
cat("\nMerged dataset dimensions:", dim(nav_with_nara), "\n")
cat("Number of unique participants:", length(unique(nav_with_nara$Participant)), "\n")
```

## Correlation Analysis (Spearman Method)

### Overall Correlations (All Participants)

```{r overall_correlations}
# Create correlation matrix for all participants using Spearman method
overall_corr_data <- nav_with_nara %>%
  filter(!is.na(NARA)) %>%
  select(all_of(outcome_measures), NARA)

# Compute Spearman correlations
overall_correlations <- overall_corr_data %>%
  correlate(method = "spearman") %>%
  focus(NARA) %>%
  arrange(desc(abs(NARA)))

# Display results
kable(overall_correlations, 
      caption = "Spearman Correlations between Navigation Measures and NARA Scores (All Participants)",
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Create a visualization
overall_corr_plot <- overall_correlations %>%
  mutate(term = factor(term, levels = term[order(NARA)])) %>%
  ggplot(aes(x = term, y = NARA)) +
  geom_col(aes(fill = NARA > 0)) +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "steelblue", "FALSE" = "coral")) +
  labs(title = "Spearman Correlations with NARA Scores (All Participants)",
       subtitle = "Spearman's rank correlation coefficient",
       x = "Navigation Measures",
       y = "Spearman Correlation with NARA") +
  theme_minimal() +
  theme(legend.position = "none")

print(overall_corr_plot)
```

### Group-Specific Correlations

```{r group_correlations}
# Function to compute Spearman correlations for a specific group
compute_group_correlations <- function(data, group_name) {
  group_data <- data %>%
    filter(Group.x == group_name, !is.na(NARA)) %>%
    select(all_of(outcome_measures), NARA)
  
  if(nrow(group_data) == 0) {
    return(data.frame(term = outcome_measures, correlation = NA))
  }
  
  # Use Spearman method
  correlations <- group_data %>%
    correlate(method = "spearman") %>%
    focus(NARA) %>%
    rename(correlation = NARA)
  
  return(correlations)
}

# Compute Spearman correlations for each group
ya_correlations <- compute_group_correlations(nav_with_nara, "YA")
oa_correlations <- compute_group_correlations(nav_with_nara, "OA")

# Combine results
group_correlations <- data.frame(
  Measure = ya_correlations$term,
  YA_Correlation = ya_correlations$correlation,
  OA_Correlation = oa_correlations$correlation
)

# Display results
kable(group_correlations, 
      caption = "Spearman Correlations between Navigation Measures and NARA Scores by Group",
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Create comparison visualization
group_corr_long <- group_correlations %>%
  reshape2::melt(id.vars = "Measure", 
                 variable.name = "Group", 
                 value.name = "Correlation") %>%
  mutate(Group = gsub("_Correlation", "", Group))

group_corr_plot <- ggplot(group_corr_long, aes(x = Measure, y = Correlation, fill = Group)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_manual(values = c("YA" = "lightblue", "OA" = "lightcoral")) +
  labs(title = "NARA Spearman Correlations by Group",
       subtitle = "Spearman's rank correlation coefficient",
       x = "Navigation Measures",
       y = "Spearman Correlation with NARA") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))

print(group_corr_plot)
```

### Statistical Significance Testing (Spearman)

```{r significance_testing}
# Function to compute Spearman correlation with p-value
compute_spearman_correlation_with_p <- function(data, group_name = NULL) {
  if(!is.null(group_name)) {
    data <- data %>% filter(Group.x == group_name)
  }
  
  data <- data %>% filter(!is.na(NARA))
  
  results <- data.frame(
    Measure = character(),
    Spearman_rho = numeric(),
    P_Value = numeric(),
    N = integer(),
    stringsAsFactors = FALSE
  )
  
  for(measure in outcome_measures) {
    if(measure %in% colnames(data)) {
      test_data <- data %>% 
        select(all_of(measure), NARA) %>%
        filter(!is.na(.data[[measure]]))
      
      if(nrow(test_data) > 2) {
        # Use Spearman correlation test
        cor_test <- cor.test(test_data[[measure]], test_data$NARA, 
                            method = "spearman", exact = FALSE)
        results <- rbind(results, data.frame(
          Measure = measure,
          Spearman_rho = cor_test$estimate,
          P_Value = cor_test$p.value,
          N = nrow(test_data)
        ))
      }
    }
  }
  
  return(results)
}

# Compute significance tests using Spearman method
overall_sig <- compute_spearman_correlation_with_p(nav_with_nara) %>%
  mutate(Group = "Overall")

ya_sig <- compute_spearman_correlation_with_p(nav_with_nara, "YA") %>%
  mutate(Group = "YA")

oa_sig <- compute_spearman_correlation_with_p(nav_with_nara, "OA") %>%
  mutate(Group = "OA")

# Combine results
all_significance <- bind_rows(overall_sig, ya_sig, oa_sig) %>%
  mutate(
    Significant = P_Value < 0.05,
    Significance = case_when(
      P_Value < 0.001 ~ "***",
      P_Value < 0.01 ~ "**",
      P_Value < 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# Display results
kable(all_significance %>% 
        select(Group, Measure, Spearman_rho, P_Value, N, Significance), 
      caption = "Spearman Correlation Analysis with Statistical Significance",
      digits = 4) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_footnote(c(
    "*** p < 0.001, ** p < 0.01, * p < 0.05",
    "Spearman's rank correlation coefficient (ρ) used throughout",
    "exact = FALSE used to handle ties in rankings"
  ))
```

### Effect Size Interpretation

```{r effect_size_interpretation}
# Add effect size interpretation for Spearman correlations
all_significance_with_effect <- all_significance %>%
  mutate(
    Effect_Size = case_when(
      abs(Spearman_rho) < 0.1 ~ "Negligible",
      abs(Spearman_rho) < 0.3 ~ "Small", 
      abs(Spearman_rho) < 0.5 ~ "Medium",
      abs(Spearman_rho) < 0.7 ~ "Large",
      abs(Spearman_rho) >= 0.7 ~ "Very Large",
      TRUE ~ "Unknown"
    ),
    Direction = case_when(
      Spearman_rho > 0 ~ "Positive",
      Spearman_rho < 0 ~ "Negative",
      TRUE ~ "None"
    )
  )

# Display with effect sizes
kable(all_significance_with_effect %>% 
        select(Group, Measure, Spearman_rho, P_Value, Significance, Effect_Size, Direction), 
      caption = "Spearman Correlations with Effect Size Interpretation",
      digits = 4) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_footnote(c(
    "Effect size interpretation for correlations:",
    "|ρ| < 0.1 = Negligible, 0.1-0.3 = Small, 0.3-0.5 = Medium, 0.5-0.7 = Large, ≥0.7 = Very Large"
  ))
```

### Summary Table

```{r summary_table}
# Create a comprehensive summary table
summary_table <- all_significance_with_effect %>%
  select(Group, Measure, Spearman_rho, P_Value, Significance, Effect_Size) %>%
  pivot_wider(names_from = Group, 
              values_from = c(Spearman_rho, P_Value, Significance, Effect_Size),
              names_sep = "_") %>%
  select(Measure, 
         Spearman_rho_Overall, P_Value_Overall, Significance_Overall, Effect_Size_Overall,
         Spearman_rho_YA, P_Value_YA, Significance_YA, Effect_Size_YA,
         Spearman_rho_OA, P_Value_OA, Significance_OA, Effect_Size_OA)

kable(summary_table, 
      caption = "Comprehensive Spearman Correlation Summary: Navigation Measures vs NARA Scores",
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 10) %>%
  scroll_box(width = "100%")
```

### Visualization of Significant Correlations

```{r significant_correlations_plot}
# Create a plot showing only significant correlations
significant_corrs <- all_significance_with_effect %>%
  filter(Significant == TRUE) %>%
  mutate(
    Group = factor(Group, levels = c("Overall", "YA", "OA")),
    Measure = factor(Measure)
  )

if(nrow(significant_corrs) > 0) {
  sig_plot <- ggplot(significant_corrs, aes(x = Measure, y = Spearman_rho, fill = Group)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(values = c("Overall" = "gray60", "YA" = "lightblue", "OA" = "lightcoral")) +
    labs(title = "Significant Spearman Correlations with NARA Scores",
         subtitle = "Only correlations with p < 0.05 shown",
         x = "Navigation Measures",
         y = "Spearman Correlation (ρ)") +
    theme_minimal() +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5)
  
  print(sig_plot)
} else {
  cat("No significant correlations found at p < 0.05 level.\n")
}
```

## Results Summary

This analysis examined **Spearman rank correlations** between eight navigation performance measures and NARA scores:

- **Total_Time**: Overall task completion time
- **Orientation_Time**: Time spent orienting in the environment  
- **Navigation_Time**: Time spent actively navigating
- **Speed**: Average movement speed
- **Distance**: Total distance traveled
- **Mean_Dwell**: Average dwell time at locations
- **Teleportations**: Number of teleportation events
- **Mean_Teleport_Distance**: Average distance of teleportations

### Key Methodological Notes:

- **Spearman's rank correlation coefficient (ρ)** was used throughout, which is appropriate for:
  - Non-normally distributed data
  - Ordinal data
  - Relationships that may not be linear
  - Data with potential outliers

- The correlations were computed for:
  1. All participants combined
  2. Younger adults (YA) separately  
  3. Older adults (OA) separately

- Statistical significance levels:
  - *** p < 0.001
  - ** p < 0.01
  - * p < 0.05

- Effect size interpretation for correlation coefficients:
  - |ρ| < 0.1 = Negligible effect
  - |ρ| 0.1-0.3 = Small effect
  - |ρ| 0.3-0.5 = Medium effect
  - |ρ| 0.5-0.7 = Large effect
  - |ρ| ≥ 0.7 = Very large effect