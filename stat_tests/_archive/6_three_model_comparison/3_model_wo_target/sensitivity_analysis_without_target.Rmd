---
title: "Sensitivity Analysis: P-value Extraction"
author: "Yasmine Bassil"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Overview

This R Markdown document extracts specific p-values from linear mixed model results for sensitivity analysis. The process involves:

1. Reading the sensitivity analysis specifications from an Excel file
2. Loading two CSV files containing contrast results
3. Matching and extracting the corresponding p-values
4. Saving the results with the extracted p-values

# Load Required Libraries

```{r load-libraries}
library(readxl)
library(dplyr)
library(readr)
library(knitr)
library(DT)
```

# Read Data Files

## Initialize Variables
```{r load-data}
# Read the template  file
sensitivity_data <- read_excel("/Volumes/YB_Drive/NavAging_Paper/stat_tests/3_model_wo_target/pval_template.xlsx")

# Read the two data CSV files
age_group_data <- read_csv("/Volumes/YB_Drive/NavAging_Paper/stat_tests/3_model_wo_target/all_contrasts_age_group.csv")
interaction_data <- read_csv("/Volumes/YB_Drive/NavAging_Paper/stat_tests/3_model_wo_target/all_contrasts_interaction.csv")
```

## Preview of Data Files

```{r preview-data}
kable(head(sensitivity_data), 
      caption = "First 6 rows of Sensitivity Analysis Specifications")

cat("Age group data dimensions:", dim(age_group_data), "\n")
cat("Interaction data dimensions:", dim(interaction_data), "\n")

# Preview age group data
kable(head(age_group_data), 
      caption = "Age Group Contrasts Data (First 6 rows)",
      digits = 6)

# Preview interaction data  
kable(head(interaction_data), 
      caption = "Interaction Contrasts Data (First 6 rows)",
      digits = 6)
```

# P-value Extraction Function

```{r extraction-function}
# Function to extract p-value based on database, outcome, and contrast
extract_pvalue <- function(database, outcome, contrast) {
  
  # Select the appropriate dataset based on database name
  if (database == "all_contrasts_age_group") {
    data_source <- age_group_data
  } else if (database == "all_contrasts_interaction") {
    data_source <- interaction_data
  } else {
    warning(paste("Unknown database:", database))
    return(NA)
  }
  
  # Filter for the specific outcome and contrast
  filtered_data <- data_source %>%
    filter(Outcome == outcome & contrast == !!contrast)
  
  # Check if we found exactly one match
  if (nrow(filtered_data) == 0) {
    warning(paste("No match found for:", database, outcome, contrast))
    return(NA)
  } else if (nrow(filtered_data) > 1) {
    warning(paste("Multiple matches found for:", database, outcome, contrast, "- using first match"))
  }
  
  # Return the p-value
  return(filtered_data$p.value[1])
}
```

# Extract P-values

```{r extract-pvalues}
# Apply the function to extract p-values for all rows in sensitivity analysis
sensitivity_results <- sensitivity_data %>%
  rowwise() %>%
  mutate(
    p_value = extract_pvalue(Database, Outcome, contrast)
  ) %>%
  ungroup()

# Display the results
cat("Sensitivity Analysis Results with P-values:\n")
```

# Results

## Complete Results Table

```{r display-results}
# Create an interactive table with the results
datatable(sensitivity_results, 
          caption = "Sensitivity Analysis Results with Extracted P-values",
          options = list(pageLength = 15, scrollX = TRUE),
          filter = 'top') %>%
  formatSignif(columns = 'p_value', digits = 3)
```

## Summary Statistics

```{r summary-stats}
# Check for any missing p-values
missing_pvalues <- sensitivity_results %>%
  filter(is.na(p_value))

# Create summary table
summary_stats <- data.frame(
  Metric = c("Total rows processed", 
             "P-values successfully extracted", 
             "Missing p-values"),
  Count = c(nrow(sensitivity_results),
            sum(!is.na(sensitivity_results$p_value)),
            sum(is.na(sensitivity_results$p_value)))
)

kable(summary_stats, caption = "Extraction Summary")
```

## Missing P-values (if any)

```{r missing-pvalues}
if (nrow(missing_pvalues) > 0) {
  cat("Warning: The following rows have missing p-values:\n")
  kable(missing_pvalues, caption = "Rows with Missing P-values")
} else {
  cat("✓ All p-values successfully extracted!\n")
}
```

# Save Results

```{r save-results}
# Save the results back to a CSV file
write_csv(sensitivity_results, "pvalues_without_target.csv")

cat("✓ Results saved to: pvalues_without_target.csv\n")
```

# Session Information

```{r session-info}
sessionInfo()
```